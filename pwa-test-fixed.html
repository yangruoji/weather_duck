<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWAä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-item { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { background: #4A90E2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ¦† PWAä¿®å¤éªŒè¯</h1>
    
    <div class="test-item info">
        <h3>1. Service WorkerçŠ¶æ€</h3>
        <div id="sw-status">æ£€æŸ¥ä¸­...</div>
        <button onclick="testServiceWorker()">æµ‹è¯•Service Worker</button>
        <button onclick="unregisterSW()">æ³¨é”€SW</button>
        <button onclick="registerNewSW()">æ³¨å†Œæ–°SW</button>
    </div>
    
    <div class="test-item info">
        <h3>2. ç¼“å­˜æµ‹è¯•</h3>
        <div id="cache-status">æœªæµ‹è¯•</div>
        <button onclick="testCache()">æµ‹è¯•ç¼“å­˜</button>
        <button onclick="clearAllCaches()">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
    </div>
    
    <div class="test-item info">
        <h3>3. å®‰è£…æç¤ºæµ‹è¯•</h3>
        <div id="install-status">ç­‰å¾…ä¸­...</div>
        <button onclick="triggerInstall()">è§¦å‘å®‰è£…</button>
    </div>
    
    <div class="test-item info">
        <h3>4. æ§åˆ¶å°æ—¥å¿—</h3>
        <div id="console-log" class="log">ç­‰å¾…æ—¥å¿—...</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script>
        let deferredPrompt;
        const logElement = document.getElementById('console-log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logElement.innerHTML = 'æ—¥å¿—å·²æ¸…é™¤<br>';
        }
        
        async function testServiceWorker() {
            const statusEl = document.getElementById('sw-status');
            
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        statusEl.className = 'test-item success';
                        statusEl.innerHTML = `
                            <h3>1. Service WorkerçŠ¶æ€</h3>
                            âœ… Service Workerå·²æ³¨å†Œ<br>
                            ä½œç”¨åŸŸ: ${registration.scope}<br>
                            çŠ¶æ€: ${registration.active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                        `;
                        log('Service WorkerçŠ¶æ€æ­£å¸¸');
                    } else {
                        statusEl.className = 'test-item warning';
                        statusEl.innerHTML = '<h3>1. Service WorkerçŠ¶æ€</h3>âš ï¸ Service Workeræœªæ³¨å†Œ';
                        log('Service Workeræœªæ³¨å†Œ');
                    }
                } else {
                    statusEl.className = 'test-item error';
                    statusEl.innerHTML = '<h3>1. Service WorkerçŠ¶æ€</h3>âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker';
                    log('æµè§ˆå™¨ä¸æ”¯æŒService Worker');
                }
            } catch (error) {
                statusEl.className = 'test-item error';
                statusEl.innerHTML = `<h3>1. Service WorkerçŠ¶æ€</h3>âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
                log('Service Workeræ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function testCache() {
            const statusEl = document.getElementById('cache-status');
            
            try {
                const cacheNames = await caches.keys();
                log(`å‘ç° ${cacheNames.length} ä¸ªç¼“å­˜: ${cacheNames.join(', ')}`);
                
                if (cacheNames.length > 0) {
                    const cache = await caches.open(cacheNames[0]);
                    const keys = await cache.keys();
                    
                    statusEl.innerHTML = `
                        âœ… ç¼“å­˜æ­£å¸¸<br>
                        ç¼“å­˜æ•°é‡: ${cacheNames.length}<br>
                        ç¼“å­˜é¡¹ç›®: ${keys.length}<br>
                        ç¼“å­˜åç§°: ${cacheNames.join(', ')}
                    `;
                    log(`ç¼“å­˜ ${cacheNames[0]} åŒ…å« ${keys.length} ä¸ªé¡¹ç›®`);
                } else {
                    statusEl.innerHTML = 'âš ï¸ æ²¡æœ‰å‘ç°ç¼“å­˜';
                    log('æ²¡æœ‰å‘ç°ä»»ä½•ç¼“å­˜');
                }
            } catch (error) {
                statusEl.innerHTML = `âŒ ç¼“å­˜æµ‹è¯•å¤±è´¥: ${error.message}`;
                log('ç¼“å­˜æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        async function clearAllCaches() {
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log(`å·²æ¸…é™¤ ${cacheNames.length} ä¸ªç¼“å­˜`);
                document.getElementById('cache-status').innerHTML = 'âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤';
            } catch (error) {
                log('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        async function unregisterSW() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    log('Service Workerå·²æ³¨é”€');
                    document.getElementById('sw-status').innerHTML = '<h3>1. Service WorkerçŠ¶æ€</h3>âœ… Service Workerå·²æ³¨é”€';
                }
            } catch (error) {
                log('æ³¨é”€Service Workerå¤±è´¥: ' + error.message);
            }
        }
        
        async function registerNewSW() {
            try {
                const registration = await navigator.serviceWorker.register('/sw-simple.js');
                log('æ–°çš„Service Workerå·²æ³¨å†Œ');
                document.getElementById('sw-status').innerHTML = '<h3>1. Service WorkerçŠ¶æ€</h3>âœ… æ–°çš„Service Workerå·²æ³¨å†Œ';
            } catch (error) {
                log('æ³¨å†Œæ–°Service Workerå¤±è´¥: ' + error.message);
            }
        }
        
        function triggerInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choiceResult => {
                    log(`å®‰è£…é€‰æ‹©: ${choiceResult.outcome}`);
                    deferredPrompt = null;
                });
            } else {
                log('æ²¡æœ‰å¯ç”¨çš„å®‰è£…æç¤º');
            }
        }
        
        // ç›‘å¬å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-status').innerHTML = 'âœ… å®‰è£…æç¤ºå¯ç”¨';
            log('å®‰è£…æç¤ºäº‹ä»¶å·²æ•è·');
        });
        
        // ç›‘å¬åº”ç”¨å®‰è£…
        window.addEventListener('appinstalled', () => {
            document.getElementById('install-status').innerHTML = 'ğŸ‰ åº”ç”¨å·²å®‰è£…';
            log('åº”ç”¨å·²æˆåŠŸå®‰è£…');
        });
        
        // ç›‘å¬Service Workeré”™è¯¯
        navigator.serviceWorker.addEventListener('error', (error) => {
            log('Service Workeré”™è¯¯: ' + error.message);
        });
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testServiceWorker();
            setTimeout(testCache, 1000);
        });
    </script>
</body>
</html>